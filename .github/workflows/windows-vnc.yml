name: Windows 11 NVIDIA Environment
on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install NVIDIA CUDA & Drivers
        run: |
          choco install cuda -y
          choco install nvidia-display-driver -y

      - name: Setup Remote Desktop (RDP)
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

      - name: Configure Custom User
        run: |
          $user = "irvyrvckadmin"
          $pass = "irvyrvck"
          # Check if user exists to avoid "Account already exists" error
          if (Get-LocalUser -Name $user -ErrorAction SilentlyContinue) {
              net user $user $pass
              Write-Host "User $user already exists. Password updated."
          } else {
              net user $user $pass /add
              net localgroup administrators $user /add
              Write-Host "User $user created successfully."
          }

      - name: Install and Start Ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          choco install ngrok -y
          ngrok config add-authtoken "$env:NGROK_AUTH_TOKEN"
          Start-Process ngrok -ArgumentList "tcp 3389"
          Start-Sleep -Seconds 15

      - name: Reveal RDP Address
        run: |
          $tunnels = Invoke-RestMethod http://localhost:4040/api/tunnels
          $public_url = $tunnels.tunnels[0].public_url
          Write-Host "--- CONNECTION DETAILS ---"
          Write-Host "Address: $public_url"
          Write-Host "Username: irvyrvckadmin"
          Write-Host "Password: irvyrvck"

      - name: Keep Alive
        run: |
          while($true) { Start-Sleep -Seconds 60 }
          
