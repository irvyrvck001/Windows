name: macOS VNC Cloud PC
on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure VNC Password
        run: |
          # Set VNC password to 'irvyrvck' for the current session
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -clientopts -setvncpw -vncpw irvyrvck
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          echo "VNC Server is configured."

      - name: Install and Start Ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          brew install ngrok
          ngrok config add-authtoken "$NGROK_AUTH_TOKEN"
          # This starts the tunnel and prints the address to the log
          ngrok tcp 5900 --log=stdout &
          sleep 10

      - name: Reveal Ngrok Address
        run: |
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'

      - name: Keep Alive
        uses: mxschmitt/action-tmate@v3
        
